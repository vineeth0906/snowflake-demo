name: Snowflake Pipeline

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      SNOWFLAKE_OCSP_FAIL_OPEN: true
      SNOWFLAKE_S3_USE_ACCELERATE_ENDPOINT: false
      SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
      SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}

    steps:
      # 1Ô∏è‚É£ Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 3Ô∏è‚É£ Install dependencies (FORCED, NO CACHE, CORRECT DIR)
      - name: Install dependencies
        working-directory: ${{ github.workspace }}
        run: |
          echo "Working directory:"
          pwd
          echo "Files:"
          ls -la
          python -m pip install --upgrade pip
          pip install --no-cache-dir -r requirements.txt

      # 4Ô∏è‚É£ VERIFY pandas (THIS IS THE KEY PROOF STEP)
      - name: Verify pandas install
        working-directory: ${{ github.workspace }}
        run: |
          pip show pandas
          python -c "import pandas; print('pandas version:', pandas.__version__)"

      # 5Ô∏è‚É£ Generate sample data
      - name: Generate data
        working-directory: ${{ github.workspace }}
        run: python generate_data.py

      # 6Ô∏è‚É£ Deploy Snowflake objects
      - name: Deploy infrastructure
        working-directory: ${{ github.workspace }}
        run: python deploy.py

      # 7Ô∏è‚É£ Load RAW layer (pandas / write_pandas)
      - name: Load raw data
        working-directory: ${{ github.workspace }}
        run: python load_raw.py

      # 8Ô∏è‚É£ Transform layers
      - name: Transform data
        working-directory: ${{ github.workspace }}
        run: python transform.py

      # 9Ô∏è‚É£ Summary
      - name: Summary
        run: |
          echo "‚úÖ Pipeline completed successfully"
          echo "ü•â RAW ‚Üí ü•à CURATED ‚Üí ü•á PUBLISH"
