# ---------------------------
# Upload CSVs to Snowflake
# ---------------------------
- name: Upload CSVs to Snowflake
  env:
    SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
    SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
    SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
    SNOWFLAKE_ROLE: ${{ secrets.SNOWFLAKE_ROLE }}
    SNOWFLAKE_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}

    # ðŸ”¥ REQUIRED FIX
    SNOWFLAKE_OCSP_FAIL_OPEN: true
    SNOWFLAKE_S3_USE_ACCELERATE_ENDPOINT: false

  run: |
    python - <<EOF
    import snowflake.connector, os

    conn = snowflake.connector.connect(
        account=os.environ["SNOWFLAKE_ACCOUNT"],
        user=os.environ["SNOWFLAKE_USER"],
        password=os.environ["SNOWFLAKE_PASSWORD"],
        role=os.environ["SNOWFLAKE_ROLE"],
        warehouse=os.environ["SNOWFLAKE_WAREHOUSE"]
    )

    cur = conn.cursor()
    cur.execute("PUT file://customers.csv @~ AUTO_COMPRESS=FALSE")
    cur.execute("PUT file://orders.csv @~ AUTO_COMPRESS=FALSE")
    cur.close()
    conn.close()
    EOF
